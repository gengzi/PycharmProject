#!/usr/bin/env python2
# -*- coding:utf-8 -*-
# Hello world - 西蒙.科泽斯 这是“向编程之神所称颂的传统咒语，愿他帮助并保佑你更好的学习这门语言
import requests
from bs4 import BeautifulSoup
import random
import time


# //div/@data-articleid
class Proxyhandler(object):
    def __init__(self):
        self.user_agent_list = [
            "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/22.0.1207.1 Safari/537.1",
            "Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11",
            "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1092.0 Safari/536.6",
            "Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.6 (KHTML, like Gecko) Chrome/20.0.1090.0 Safari/536.6",
            "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/19.77.34.5 Safari/537.1",
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.9 Safari/536.5",
            "Mozilla/5.0 (Windows NT 6.0) AppleWebKit/536.5 (KHTML, like Gecko) Chrome/19.0.1084.36 Safari/536.5",
            "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1063.0 Safari/536.3",
            "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1063.0 Safari/536.3",
            "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_0) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1063.0 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1062.0 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1062.0 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1061.1 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1061.1 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1061.1 Safari/536.3",
            "Mozilla/5.0 (Windows NT 6.2) AppleWebKit/536.3 (KHTML, like Gecko) Chrome/19.0.1061.0 Safari/536.3",
            "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/535.24 (KHTML, like Gecko) Chrome/19.0.1055.1 Safari/535.24",
            "Mozilla/5.0 (Windows NT 6.2; WOW64) AppleWebKit/535.24 (KHTML, like Gecko) Chrome/19.0.1055.1 Safari/535.24"]
        self.proxy_url = 'https://www.xicidaili.com/wn/'
        # 获取的代理IP列表
        self.proxy_list = []
        # 目标网址
        self.target_url = 'https://blog.csdn.net/qq_28817739/article/details/105544222'
        self.target_urltemp = 'https://blog.csdn.net/qq_28817739/article/details/'
        self.codes = [105544222,
                      105524194,
                      105473767,
                      105473757,
                      105473725,
                      105473672,
                      105459539,
                      105459507,
                      105459480,
                      105459467,
                      105459446,
                      105459302,
                      105459148,
                      105316635,
                      105314556,
                      103017647,
                      102942544,
                      102923570,
                      94674781,
                      93844076,
                      93843919,
                      93843731,
                      93843599,
                      89934243,
                      88701805,
                      88431787,
                      88212806,
                      88083154,
                      88082236,
                      88081000,
                      87834514,
                      87740998,
                      86084544,
                      85157471,
                      85124364,
                      85106837,
                      85077079,
                      84669483,
                      84669467,
                      84669464,
                      84669460,
                      84669452,
                      84669444,
                      84669412,
                      84668413,
                      84520865,
                      84501454,
                      84228523,
                      84024418,
                      83388018,
                      82961640,
                      82851770,
                      82846349,
                      82796926,
                      81865121,
                      81706842,
                      81532496,
                      81485711,
                      81329008,
                      81319138,
                      81293676,
                      81255652,
                      81255476,
                      81138463,
                      81138441,
                      81138432,
                      81138424,
                      81138412,
                      81120982,
                      81120752,
                      81120528,
                      81106955,
                      81087137,
                      81086917,
                      80967769,
                      80910856,
                      80910471,
                      80902879,
                      80900481,
                      80887068,
                      80883946,
                      80875565,
                      80874844,
                      80870817,
                      80867843,
                      80859695,
                      80766640,
                      80765554,
                      80765513,
                      80765314,
                      80765267,
                      80765236,
                      80765208,
                      80765151,
                      80765058,
                      80564076,
                      80563836,
                      80489097,
                      80481932,
                      80481032,
                      80462837,
                      80451755,
                      80437398,
                      80437379,
                      80432666,
                      80431675,
                      80432347,
                      80431529,
                      80431284,
                      80427125,
                      80425166,
                      80425135,
                      80425031,
                      80152469,
                      80145208,
                      80119328,
                      80070467,
                      80054609,
                      80052907,
                      80052228,
                      80042590,
                      79967940,
                      79953359,
                      79904391,
                      79721553,
                      79318667,
                      79041192,
                      79023405,
                      78941378,
                      78650830,
                      78472766,
                      78299776,
                      78289071,
                      78276357,
                      78275872,
                      78273901,
                      78237599,
                      78208097,
                      78207938,
                      78162552,
                      78082938,
                      78075884,
                      78075691,
                      78053087,
                      78027463,
                      78009225,
                      78005527,
                      78002626,
                      77971028,
                      77934096,
                      77917862,
                      77917771,
                      77916925,
                      77916881,
                      77916723,
                      77916588,
                      77872068,
                      77856991,
                      77771371,
                      77718056,
                      77542860,
                      77512175,
                      77511837,
                      74852687,
                      73693491,
                      73431172,
                      71857419,
                      70946788,
                      70236581,
                      69666485,
                      66973787,
                      61921126,
                      61420857,
                      61420557,
                      58186359,
                      57402719,
                      57086827,
                      57086412,
                      56851634,
                      56670905,
                      56496613,
                      54916163,
                      54812214,
                      54604756,
                      54564397,
                      53511673,
                      53457468,
                      53446525,
                      53446476,
                      53340553,
                      53243967,
                      53232548,
                      53217638,
                      53193424,
                      53180175,
                      53173189,
                      53166537,
                      53138897,
                      52938978,
                      52927865,
                      52887021,
                      52887014,
                      52865199,
                      52863616,
                      52854172,
                      52852175,
                      52852167,
                      52809566,
                      52792132,
                      52782682,
                      52778125,
                      52760902,
                      52751989,
                      52746106,
                      52718246,
                      52718242,
                      52718227,
                      52718226,
                      52718224,
                      52718220,
                      52718215,
                      52718214,
                      52718212,
                      52718211,
                      52718208,
                      52718204,
                      52718203,
                      52718196,
                      52382199,
                      52373968,
                      51223015,
                      51212238,
                      105544222,
                      105524194,
                      105473767,
                      105473757,
                      105473725,
                      105473672,
                      105459539,
                      105459507,
                      105459480,
                      105459467,
                      105459446,
                      105459302,
                      105459148,
                      105316635,
                      105314556,
                      103017647,
                      102942544,
                      102923570,
                      94674781,
                      93844076,
                      93843919,
                      93843731,
                      93843599,
                      89934243,
                      88701805,
                      88431787,
                      88212806,
                      88083154,
                      88082236,
                      88081000,
                      87834514,
                      87740998,
                      86084544,
                      85157471,
                      85124364,
                      85106837,
                      85077079,
                      84669483,
                      84669467,
                      84669464,
                      84669460,
                      84669452,
                      84669444,
                      84669412,
                      84668413,
                      84520865,
                      84501454,
                      84228523,
                      84024418,
                      83388018,
                      82961640,
                      82851770,
                      82846349,
                      82796926,
                      81865121,
                      81706842,
                      81532496,
                      81485711,
                      81329008,
                      81319138,
                      81293676,
                      81255652,
                      81255476,
                      81138463,
                      81138441,
                      81138432,
                      81138424,
                      81138412,
                      81120982,
                      81120752,
                      81120528,
                      81106955,
                      81087137,
                      81086917,
                      80967769,
                      80910856,
                      80910471,
                      80902879,
                      80900481,
                      80887068,
                      80883946,
                      80875565,
                      80874844,
                      80870817,
                      80867843,
                      80859695,
                      80766640,
                      80765554,
                      80765513,
                      80765314,
                      80765267,
                      80765236,
                      80765208,
                      80765151,
                      80765058,
                      80564076,
                      80563836,
                      80489097,
                      80481932,
                      80481032,
                      80462837,
                      80451755,
                      80437398,
                      80437379,
                      80432666,
                      80431675,
                      80432347,
                      80431529,
                      80431284,
                      80427125,
                      80425166,
                      80425135,
                      80425031,
                      80152469,
                      80145208,
                      80119328,
                      80070467,
                      80054609,
                      80052907,
                      80052228,
                      80042590,
                      79967940,
                      79953359,
                      79904391,
                      79721553,
                      79318667,
                      79041192,
                      79023405,
                      78941378,
                      78650830,
                      78472766,
                      78299776,
                      78289071,
                      78276357,
                      78275872,
                      78273901,
                      78237599,
                      78208097,
                      78207938,
                      78162552,
                      78082938,
                      78075884,
                      78075691,
                      78053087,
                      78027463,
                      78009225,
                      78005527,
                      78002626,
                      77971028,
                      77934096,
                      77917862,
                      77917771,
                      77916925,
                      77916881,
                      77916723,
                      77916588,
                      77872068,
                      77856991,
                      77771371,
                      77718056,
                      77542860,
                      77512175,
                      77511837,
                      74852687,
                      73693491,
                      73431172,
                      71857419,
                      70946788,
                      70236581,
                      69666485,
                      66973787,
                      61921126,
                      61420857,
                      61420557,
                      58186359,
                      57402719,
                      57086827,
                      57086412,
                      56851634,
                      56670905,
                      56496613,
                      54916163,
                      54812214,
                      54604756,
                      54564397,
                      53511673,
                      53457468,
                      53446525,
                      53446476,
                      53340553,
                      53243967,
                      53232548,
                      53217638,
                      53193424,
                      53180175,
                      53173189,
                      53166537,
                      53138897,
                      52938978,
                      52927865,
                      52887021,
                      52887014,
                      52865199,
                      52863616,
                      52854172,
                      52852175,
                      52852167,
                      52809566,
                      52792132,
                      52782682,
                      52778125,
                      52760902,
                      52751989,
                      52746106,
                      52718246,
                      52718242,
                      52718227,
                      52718226,
                      52718224,
                      52718220,
                      52718215,
                      52718214,
                      52718212,
                      52718211,
                      52718208,
                      52718204,
                      52718203,
                      52718196,
                      52382199,
                      52373968,
                      51223015,
                      51212238,
                      105544222,
                      105524194,
                      105473767,
                      105473757,
                      105473725,
                      105473672,
                      105459539,
                      105459507,
                      105459480,
                      105459467,
                      105459446,
                      105459302,
                      105459148,
                      105316635,
                      105314556,
                      103017647,
                      102942544,
                      102923570,
                      94674781,
                      93844076,
                      93843919,
                      93843731,
                      93843599,
                      89934243,
                      88701805,
                      88431787,
                      88212806,
                      88083154,
                      88082236,
                      88081000,
                      87834514,
                      87740998,
                      86084544,
                      85157471,
                      85124364,
                      85106837,
                      85077079,
                      84669483,
                      84669467,
                      84669464,
                      84669460,
                      84669452,
                      84669444,
                      84669412,
                      84668413,
                      84520865,
                      84501454,
                      84228523,
                      84024418,
                      83388018,
                      82961640,
                      82851770,
                      82846349,
                      82796926,
                      81865121,
                      81706842,
                      81532496,
                      81485711,
                      81329008,
                      81319138,
                      81293676,
                      81255652,
                      81255476,
                      81138463,
                      81138441,
                      81138432,
                      81138424,
                      81138412,
                      81120982,
                      81120752,
                      81120528,
                      81106955,
                      81087137,
                      81086917,
                      80967769,
                      80910856,
                      80910471,
                      80902879,
                      80900481,
                      80887068,
                      80883946,
                      80875565,
                      80874844,
                      80870817,
                      80867843,
                      80859695,
                      80766640,
                      80765554,
                      80765513,
                      80765314,
                      80765267,
                      80765236,
                      80765208,
                      80765151,
                      80765058,
                      80564076,
                      80563836,
                      80489097,
                      80481932,
                      80481032,
                      80462837,
                      80451755,
                      80437398,
                      80437379,
                      80432666,
                      80431675,
                      80432347,
                      80431529,
                      80431284,
                      80427125,
                      80425166,
                      80425135,
                      80425031,
                      80152469,
                      80145208,
                      80119328,
                      80070467,
                      80054609,
                      80052907,
                      80052228,
                      80042590,
                      79967940,
                      79953359,
                      79904391,
                      79721553,
                      79318667,
                      79041192,
                      79023405,
                      78941378,
                      78650830,
                      78472766,
                      78299776,
                      78289071,
                      78276357,
                      78275872,
                      78273901,
                      78237599,
                      78208097,
                      78207938,
                      78162552,
                      78082938,
                      78075884,
                      78075691,
                      78053087,
                      78027463,
                      78009225,
                      78005527,
                      78002626,
                      77971028,
                      77934096,
                      77917862,
                      77917771,
                      77916925,
                      77916881,
                      77916723,
                      77916588,
                      77872068,
                      77856991,
                      77771371,
                      77718056,
                      77542860,
                      77512175,
                      77511837,
                      74852687,
                      73693491,
                      73431172,
                      71857419,
                      70946788,
                      70236581,
                      69666485,
                      66973787,
                      61921126,
                      61420857,
                      61420557,
                      58186359,
                      57402719,
                      57086827,
                      57086412,
                      56851634,
                      56670905,
                      56496613,
                      54916163,
                      54812214,
                      54604756,
                      54564397,
                      53511673,
                      53457468,
                      53446525,
                      53446476,
                      53340553,
                      53243967,
                      53232548,
                      53217638,
                      53193424,
                      53180175,
                      53173189,
                      53166537,
                      53138897,
                      52938978,
                      52927865,
                      52887021,
                      52887014,
                      52865199,
                      52863616,
                      52854172,
                      52852175,
                      52852167,
                      52809566,
                      52792132,
                      52782682,
                      52778125,
                      52760902,
                      52751989,
                      52746106,
                      52718246,
                      52718242,
                      52718227,
                      52718226,
                      52718224,
                      52718220,
                      52718215,
                      52718214,
                      52718212,
                      52718211,
                      52718208,
                      52718204,
                      52718203,
                      52718196,
                      52382199,
                      52373968,
                      51223015,
                      51212238
                      ]
        self.time_out = 3

    # 爬取代理IP存入列表，并删除无效IP，设定爬取10页的IP
    def get_proxy_list(self, page_num=10):
        # 从user_agent_list列表中随机选取一个header
        ua = random.choice(self.user_agent_list)
        header = {'User-Agent': ua}
        print('随机产生的UA:%s' % ua)
        try:
            for i in range(page_num):
                url = self.proxy_url + str(i + 1)
                r = requests.get(url, headers=header, timeout=self.time_out)
                r.raise_for_status()
                r.encoding = r.apparent_encoding
                html = r.text
                soup = BeautifulSoup(html, 'html.parser')
                tr = soup.find_all('tr')
                for i in range(1, len(tr)):
                    t = tr[i]
                    td = t.find_all('td')
                    self.proxy_list.append(td[1].text + ':' + td[2].text)
            for ip in self.proxy_list:
                try:
                    proy_host = 'https://' + ip
                    proxy = {'https:': proy_host}
                    response = requests(self.target_url, headers=header, proxies=proxy)
                # 删除列表中出现异常的无效IP
                except Exception as e:
                    self.proxy_list.remove(ip)
                    continue
            # 返回有效IP列表
            return self.proxy_list
        except:
            print('get error!')

    # 通过爬取的代理IP访问目标网址
    def get_target_html(self, list,index):
        try:
            ua = random.choice(self.user_agent_list)
            header = {'User-Agent': ua}
            proy_host = 'https://' + str(random.choice(list))
            proxy = {'https:': proy_host}
            print(proxy)
            print(self.target_urltemp+str(self.codes[index]))
            r = requests.get(self.target_urltemp+str(self.codes[index]), headers=header, proxies=proxy, timeout=30)
            r.encoding = r.apparent_encoding
            r.raise_for_status()
            soup = BeautifulSoup(r.text, 'html.parser')
            title = soup.find('title').string
            print(title)
        except Exception as e:
            print(e)
            print('getHTML error')


if __name__ == '__main__':
    # 实例化Proxyhandler类
    for i in range(10):
        proxy_hander = Proxyhandler()
        list = proxy_hander.get_proxy_list()
        print(list)
        for i in range(231*2):
            proxy_hander.get_target_html(list,i)
            time.sleep(5)
